"use strict";
const winston = require("winston");
const path = require("path");
const _ = require("lodash");
const fs = require("fs-extra");
const stackTrace = require("stack-trace");
let config = {
    'default': 'info'
};
let mkLogConfig = (label, level) => {
    return {
        level: level,
        transports: [
            new (winston.transports.Console)({ colorize: true, label: label })
        ]
    };
};
const logger = addLogger('LOG_FACTORY');
exports.init = (log) => {
    logger.debug('init: ', log);
    if (!log) {
        return;
    }
    if (_.isObject(log)) {
        setConfig(log);
    }
    else if (isLogLevel(log)) {
        exports.setDefaultLevel(log);
    }
    else {
        try {
            let config = JSON.parse(log);
            logger.debug('parsed log: ', log);
            setConfig(config);
        }
        catch (e) {
            if (fs.existsSync(log)) {
                setConfigFromFile(log);
            }
            else {
                console.error('can not configure logging using cli param value: ' + log);
            }
        }
    }
};
function addLogger(label, level) {
    level = level ? level : config['default'] || 'info';
    let cfg = mkLogConfig(label, level);
    let logger;
    if (winston.loggers.has(label)) {
        logger = winston.loggers.get(label);
    }
    else {
        logger = winston.loggers.add(label, {});
    }
    logger.configure(cfg);
    return logger;
}
let isLogLevel = (l) => _.includes(['error', 'warn', 'info', 'verbose', 'debug', 'silly'], l);
exports.setDefaultLevel = (l) => {
    config = _.merge(config, { 'default': l });
    logger.debug('default level now: ', config['default']);
    _.forEach(winston.loggers.loggers, (value, key) => {
        let logger = winston.loggers.get(key);
        let cfg = mkLogConfig(key, config['default']);
        logger.configure(cfg);
    });
};
let setConfigFromFile = (configPath) => {
    var cfg = fs.readJsonSync(configPath);
    logger.debug(cfg);
    setConfig(cfg);
};
let setConfig = (cfg) => {
    config = _.merge({}, config, cfg);
    _.forIn(cfg, (value, key) => {
        addLogger(key, value);
    });
};
exports.getLogger = (id) => {
    var existing = winston.loggers.has(id);
    if (existing) {
        return winston.loggers.get(id);
    }
    else {
        return addLogger(id, config[id] || config['default']);
    }
};
exports.fileLogger = (filename) => {
    var label;
    var parsed = path.parse(filename);
    if (parsed.name === 'index') {
        label = path.basename(parsed.dir);
    }
    else {
        label = parsed.name;
    }
    return exports.getLogger(label);
};
function buildLogger() {
    let trace = stackTrace.get();
    let name = trace[1].getFileName();
    return exports.fileLogger(name);
}
exports.buildLogger = buildLogger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RSxDQUFDO0lBQ2xDLE1BQU0sQ0FBQyxrQkFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzFCLENBQUM7QUFKRCxrQ0FJQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHdpbnN0b24gZnJvbSAnd2luc3Rvbic7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgc3RhY2tUcmFjZSBmcm9tICdzdGFjay10cmFjZSc7XG5cbi8vbGV2ZWxzOiBlcnJvciA+IHdhcm4gPiBpbmZvID4gdmVyYm9zZSA+IGRlYnVnID4gc2lsbHlcblxubGV0IGNvbmZpZyA9IHtcbiAgJ2RlZmF1bHQnOiAnaW5mbydcbn07XG5cbmxldCBta0xvZ0NvbmZpZyA9IChsYWJlbDogc3RyaW5nLCBsZXZlbDogc3RyaW5nKSA9PiB7XG4gIHJldHVybiB7XG4gICAgbGV2ZWw6IGxldmVsLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgIG5ldyAod2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUpKHsgY29sb3JpemU6IHRydWUsIGxhYmVsOiBsYWJlbCB9KVxuICAgIF1cbiAgfVxufVxuXG5jb25zdCBsb2dnZXIgPSBhZGRMb2dnZXIoJ0xPR19GQUNUT1JZJyk7XG5cbmV4cG9ydCBsZXQgaW5pdCA9IChsb2cpOiB2b2lkID0+IHtcblxuICBsb2dnZXIuZGVidWcoJ2luaXQ6ICcsIGxvZyk7XG5cbiAgaWYgKCFsb2cpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoXy5pc09iamVjdChsb2cpKSB7XG4gICAgc2V0Q29uZmlnKGxvZyk7XG4gIH0gZWxzZSBpZiAoaXNMb2dMZXZlbChsb2cpKSB7XG4gICAgc2V0RGVmYXVsdExldmVsKGxvZyk7XG4gIH0gZWxzZSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBjb25maWcgPSBKU09OLnBhcnNlKGxvZyk7XG4gICAgICBsb2dnZXIuZGVidWcoJ3BhcnNlZCBsb2c6ICcsIGxvZyk7XG4gICAgICBzZXRDb25maWcoY29uZmlnKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhsb2cpKSB7XG4gICAgICAgIHNldENvbmZpZ0Zyb21GaWxlKGxvZyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdjYW4gbm90IGNvbmZpZ3VyZSBsb2dnaW5nIHVzaW5nIGNsaSBwYXJhbSB2YWx1ZTogJyArIGxvZyk7XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG5cbmZ1bmN0aW9uIGFkZExvZ2dlcihsYWJlbCwgbGV2ZWw/OiBzdHJpbmcpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlIHtcblxuICBsZXZlbCA9IGxldmVsID8gbGV2ZWwgOiBjb25maWdbJ2RlZmF1bHQnXSB8fCAnaW5mbyc7XG4gIGxldCBjZmcgPSBta0xvZ0NvbmZpZyhsYWJlbCwgbGV2ZWwpO1xuICBsZXQgbG9nZ2VyO1xuICBpZiAod2luc3Rvbi5sb2dnZXJzLmhhcyhsYWJlbCkpIHtcbiAgICBsb2dnZXIgPSB3aW5zdG9uLmxvZ2dlcnMuZ2V0KGxhYmVsKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIgPSB3aW5zdG9uLmxvZ2dlcnMuYWRkKGxhYmVsLCB7fSk7XG4gIH1cblxuICBsb2dnZXIuY29uZmlndXJlKGNmZyk7XG4gIHJldHVybiBsb2dnZXI7XG59XG5cblxubGV0IGlzTG9nTGV2ZWwgPSAobCk6IEJvb2xlYW4gPT4gXy5pbmNsdWRlcyhbJ2Vycm9yJywgJ3dhcm4nLCAnaW5mbycsICd2ZXJib3NlJywgJ2RlYnVnJywgJ3NpbGx5J10sIGwpO1xuXG5cbmV4cG9ydCBsZXQgc2V0RGVmYXVsdExldmVsID0gKGwpID0+IHtcbiAgY29uZmlnID0gXy5tZXJnZShjb25maWcsIHsgJ2RlZmF1bHQnOiBsIH0pO1xuICBsb2dnZXIuZGVidWcoJ2RlZmF1bHQgbGV2ZWwgbm93OiAnLCBjb25maWdbJ2RlZmF1bHQnXSk7XG4gIF8uZm9yRWFjaCh3aW5zdG9uLmxvZ2dlcnMubG9nZ2VycywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICBsZXQgbG9nZ2VyID0gd2luc3Rvbi5sb2dnZXJzLmdldChrZXkpO1xuICAgIGxldCBjZmcgPSBta0xvZ0NvbmZpZyhrZXksIGNvbmZpZ1snZGVmYXVsdCddKTtcbiAgICBsb2dnZXIuY29uZmlndXJlKGNmZyk7XG4gIH0pO1xufTtcblxubGV0IHNldENvbmZpZ0Zyb21GaWxlID0gKGNvbmZpZ1BhdGgpID0+IHtcbiAgdmFyIGNmZyA9IGZzLnJlYWRKc29uU3luYyhjb25maWdQYXRoKTtcbiAgbG9nZ2VyLmRlYnVnKGNmZyk7XG4gIHNldENvbmZpZyhjZmcpO1xufTtcblxubGV0IHNldENvbmZpZyA9IChjZmcpID0+IHtcbiAgY29uZmlnID0gXy5tZXJnZSh7fSwgY29uZmlnLCBjZmcpO1xuICBfLmZvckluKGNmZywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICBhZGRMb2dnZXIoa2V5LCB2YWx1ZSk7XG4gIH0pO1xufTtcblxuLyoqIGdldCBhIGxvZ2dlciBhbmQgZ2l2ZSBpdCBhIG5hbWUgKi9cbmV4cG9ydCBsZXQgZ2V0TG9nZ2VyID0gKGlkOiBzdHJpbmcpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlID0+IHtcbiAgdmFyIGV4aXN0aW5nID0gd2luc3Rvbi5sb2dnZXJzLmhhcyhpZCk7XG5cbiAgaWYgKGV4aXN0aW5nKSB7XG4gICAgcmV0dXJuIHdpbnN0b24ubG9nZ2Vycy5nZXQoaWQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhZGRMb2dnZXIoaWQsIGNvbmZpZ1tpZF0gfHwgY29uZmlnWydkZWZhdWx0J10pO1xuICB9XG59O1xuXG4vKiogZ2V0IGEgbG9nZ2VyIGFuZCBuYW1lIGl0IGJ5IGl0J3MgZmlsZSBuYW1lLiAqL1xuZXhwb3J0IGxldCBmaWxlTG9nZ2VyID0gKGZpbGVuYW1lKTogd2luc3Rvbi5Mb2dnZXJJbnN0YW5jZSA9PiB7XG4gIHZhciBsYWJlbDtcbiAgdmFyIHBhcnNlZCA9IHBhdGgucGFyc2UoZmlsZW5hbWUpO1xuXG4gIGlmIChwYXJzZWQubmFtZSA9PT0gJ2luZGV4Jykge1xuICAgIGxhYmVsID0gcGF0aC5iYXNlbmFtZShwYXJzZWQuZGlyKTtcbiAgfSBlbHNlIHtcbiAgICBsYWJlbCA9IHBhcnNlZC5uYW1lO1xuICB9XG4gIHJldHVybiBnZXRMb2dnZXIobGFiZWwpO1xufVxuXG4vKipcbiAqIENyZWF0ZSBhIGxvZ2dlciBhbmQgYXV0b21hdGljYWxseSBuYW1lIGl0IGJ5IHVzaW5nIHRoZSBmaWxlbmFtZSBvZiB0aGUgY2FsbCBzaXRlLlxuICogRWc6IFxuICogYGBgXG4gKiAvL215LWZpbGUuanNcbiAqIGltcG9ydCB7YnVpbGRMb2dnZXJ9IGZyb20gJ2xvZy1mYWN0b3J5JztcbiAqIGxldCBsb2dnZXIgPSBidWlsZExvZ2dlcigpO1xuICogbG9nZ2VyLmluZm8oJ2hpJykgLy89PiBlbWl0cyBbSU5GT10gW215LWZpbGVdIGhpIFxuICogYGBgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBidWlsZExvZ2dlcigpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlIHtcbiAgbGV0IHRyYWNlID0gc3RhY2tUcmFjZS5nZXQoKTtcbiAgbGV0IG5hbWUgPSB0cmFjZVsxXS5nZXRGaWxlTmFtZSgpO1xuICByZXR1cm4gZmlsZUxvZ2dlcihuYW1lKTtcbn1cblxuXG4iXX0=
