"use strict";
const _ = require("lodash");
const dateFormat = require("dateformat");
const fs = require("fs");
const path = require("path");
const stackTrace = require("stack-trace");
const winston = require("winston");
const moduleOpts = {
    console: true,
    file: null,
    log: 'info'
};
let config = {
    'default': 'info'
};
const timestamp = () => {
    var now = new Date();
    return dateFormat(now, 'HH:MM:ss.l');
};
const consoleTransport = (label) => {
    return new (winston.transports.Console)({
        colorize: true,
        label: label,
        timestamp
    });
};
const fileTransport = (label) => {
    return new winston.transports.File({
        colorize: false,
        json: false,
        filename: moduleOpts.file,
        label,
        timestamp
    });
};
const mkLogConfig = (label, level) => {
    const addConsole = !moduleOpts.file && moduleOpts.console;
    const transports = [
        addConsole ? consoleTransport(label) : null,
        moduleOpts.file ? fileTransport(label) : null
    ].filter(t => t !== null);
    return { level, transports };
};
const setConfig = (cfg) => {
    config = _.merge({}, config, cfg);
    _.forIn(cfg, (value, key) => {
        addLogger(key, value);
    });
};
const isLogLevel = (l) => _.includes(['error', 'warn', 'info', 'verbose', 'debug', 'silly'], l);
exports.setDefaultLevel = (l) => {
    config = _.merge(config, { 'default': l });
    _.forEach(winston.loggers.loggers, (value, key) => {
        let logger = winston.loggers.get(key);
        let cfg = mkLogConfig(key, config['default']);
        logger.configure(cfg);
    });
};
exports.init = (opts) => {
    moduleOpts.console = opts.console;
    moduleOpts.file = opts.file;
    moduleOpts.log = opts.log || moduleOpts.log;
    const { log } = moduleOpts;
    if (!log) {
        return;
    }
    if (_.isObject(log)) {
        setConfig(log);
    }
    else if (isLogLevel(log)) {
        exports.setDefaultLevel(log);
    }
    else {
        try {
            let config = JSON.parse(log);
            setConfig(config);
        }
        catch (e) {
            if (fs.existsSync(log)) {
                var cfg = JSON.parse(fs.readFileSync(log, 'utf8'));
                setConfig(cfg);
            }
            else {
                console.error('can not configure logging using cli param value: ' + log);
            }
        }
    }
};
function addLogger(label, level) {
    level = level ? level : config['default'] || 'info';
    let cfg = mkLogConfig(label, level);
    let logger;
    if (winston.loggers.has(label)) {
        logger = winston.loggers.get(label);
    }
    else {
        logger = winston.loggers.add(label, {});
    }
    logger.configure(cfg);
    return logger;
}
exports.getLogger = (id) => {
    var existing = winston.loggers.has(id);
    if (existing) {
        return winston.loggers.get(id);
    }
    else {
        return addLogger(id, config[id] || config['default']);
    }
};
exports.fileLogger = (filename) => {
    var label;
    var parsed = path.parse(filename);
    if (parsed.name === 'index') {
        label = path.basename(parsed.dir);
    }
    else {
        label = parsed.name;
    }
    return exports.getLogger(label);
};
function buildLogger() {
    let trace = stackTrace.get();
    let name = trace[1].getFileName();
    return exports.fileLogger(name);
}
exports.buildLogger = buildLogger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUN4RCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBR1csUUFBQSxVQUFVLEdBQUcsQ0FBQyxRQUFRO0lBQ2pDLElBQUksS0FBSyxDQUFDO0lBQ1YsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUVsQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDNUIsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ3RCLENBQUM7SUFDRCxNQUFNLENBQUMsaUJBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMxQixDQUFDLENBQUM7QUFZRjtJQUNFLElBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3QixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbEMsTUFBTSxDQUFDLGtCQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDMUIsQ0FBQztBQUpELGtDQUlDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICogYXMgZGF0ZUZvcm1hdCBmcm9tICdkYXRlZm9ybWF0JztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBzdGFja1RyYWNlIGZyb20gJ3N0YWNrLXRyYWNlJztcbmltcG9ydCAqIGFzIHdpbnN0b24gZnJvbSAnd2luc3Rvbic7XG5cbi8vbGV2ZWxzOiBlcnJvciA+IHdhcm4gPiBpbmZvID4gdmVyYm9zZSA+IGRlYnVnID4gc2lsbHlcblxudHlwZSBMb2dGYWN0b3J5T3B0cyA9IHtcbiAgY29uc29sZTogYm9vbGVhbixcbiAgZmlsZT86IHN0cmluZyxcbiAgbG9nPzogYW55XG59O1xuXG5jb25zdCBtb2R1bGVPcHRzID0ge1xuICBjb25zb2xlOiB0cnVlLFxuICBmaWxlOiBudWxsLFxuICBsb2c6ICdpbmZvJ1xufTtcblxubGV0IGNvbmZpZyA9IHtcbiAgJ2RlZmF1bHQnOiAnaW5mbydcbn07XG5cbmNvbnN0IHRpbWVzdGFtcCA9ICgpID0+IHtcbiAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7XG4gIHJldHVybiBkYXRlRm9ybWF0KG5vdywgJ0hIOk1NOnNzLmwnKTtcbn07XG5cbmNvbnN0IGNvbnNvbGVUcmFuc3BvcnQgPSAobGFiZWw6IHN0cmluZyk6IHdpbnN0b24uVHJhbnNwb3J0SW5zdGFuY2UgPT4ge1xuICByZXR1cm4gbmV3ICh3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSkoe1xuICAgIGNvbG9yaXplOiB0cnVlLFxuICAgIGxhYmVsOiBsYWJlbCxcbiAgICB0aW1lc3RhbXBcbiAgfSk7XG59O1xuXG5jb25zdCBmaWxlVHJhbnNwb3J0ID0gKGxhYmVsOiBzdHJpbmcpOiB3aW5zdG9uLlRyYW5zcG9ydEluc3RhbmNlID0+IHtcbiAgcmV0dXJuIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuRmlsZSh7XG4gICAgY29sb3JpemU6IGZhbHNlLFxuICAgIGpzb246IGZhbHNlLFxuICAgIGZpbGVuYW1lOiBtb2R1bGVPcHRzLmZpbGUsXG4gICAgbGFiZWwsXG4gICAgdGltZXN0YW1wXG4gIH0pO1xufTtcblxuY29uc3QgbWtMb2dDb25maWcgPSAobGFiZWw6IHN0cmluZywgbGV2ZWw6IHN0cmluZykgPT4ge1xuXG4gIGNvbnN0IGFkZENvbnNvbGUgPSAhbW9kdWxlT3B0cy5maWxlICYmIG1vZHVsZU9wdHMuY29uc29sZTtcblxuICBjb25zdCB0cmFuc3BvcnRzOiB3aW5zdG9uLlRyYW5zcG9ydEluc3RhbmNlW10gPSBbXG4gICAgYWRkQ29uc29sZSA/IGNvbnNvbGVUcmFuc3BvcnQobGFiZWwpIDogbnVsbCxcbiAgICBtb2R1bGVPcHRzLmZpbGUgPyBmaWxlVHJhbnNwb3J0KGxhYmVsKSA6IG51bGxcbiAgXS5maWx0ZXIodCA9PiB0ICE9PSBudWxsKTtcblxuXG4gIHJldHVybiB7IGxldmVsLCB0cmFuc3BvcnRzIH07XG59O1xuXG5cbmNvbnN0IHNldENvbmZpZyA9IChjZmcpID0+IHtcbiAgY29uZmlnID0gXy5tZXJnZSh7fSwgY29uZmlnLCBjZmcpO1xuICBfLmZvckluKGNmZywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICBhZGRMb2dnZXIoa2V5LCB2YWx1ZSk7XG4gIH0pO1xufTtcblxuY29uc3QgaXNMb2dMZXZlbCA9IChsKTogQm9vbGVhbiA9PiBfLmluY2x1ZGVzKFsnZXJyb3InLCAnd2FybicsICdpbmZvJywgJ3ZlcmJvc2UnLCAnZGVidWcnLCAnc2lsbHknXSwgbCk7XG5cbmV4cG9ydCBjb25zdCBzZXREZWZhdWx0TGV2ZWwgPSAobCkgPT4ge1xuICBjb25maWcgPSBfLm1lcmdlKGNvbmZpZywgeyAnZGVmYXVsdCc6IGwgfSk7XG4gIF8uZm9yRWFjaCh3aW5zdG9uLmxvZ2dlcnMubG9nZ2VycywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICBsZXQgbG9nZ2VyID0gd2luc3Rvbi5sb2dnZXJzLmdldChrZXkpO1xuICAgIGxldCBjZmcgPSBta0xvZ0NvbmZpZyhrZXksIGNvbmZpZ1snZGVmYXVsdCddKTtcbiAgICBsb2dnZXIuY29uZmlndXJlKGNmZyk7XG4gIH0pO1xufTtcblxuZXhwb3J0IGNvbnN0IGluaXQgPSAob3B0czogTG9nRmFjdG9yeU9wdHMpOiB2b2lkID0+IHtcblxuICBtb2R1bGVPcHRzLmNvbnNvbGUgPSBvcHRzLmNvbnNvbGU7XG4gIG1vZHVsZU9wdHMuZmlsZSA9IG9wdHMuZmlsZTtcbiAgbW9kdWxlT3B0cy5sb2cgPSBvcHRzLmxvZyB8fCBtb2R1bGVPcHRzLmxvZztcblxuICBjb25zdCB7IGxvZyB9ID0gbW9kdWxlT3B0cztcblxuICBpZiAoIWxvZykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChfLmlzT2JqZWN0KGxvZykpIHtcbiAgICBzZXRDb25maWcobG9nKTtcbiAgfSBlbHNlIGlmIChpc0xvZ0xldmVsKGxvZykpIHtcbiAgICBzZXREZWZhdWx0TGV2ZWwobG9nKTtcbiAgfSBlbHNlIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGNvbmZpZyA9IEpTT04ucGFyc2UobG9nKTtcbiAgICAgIHNldENvbmZpZyhjb25maWcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKGxvZykpIHtcbiAgICAgICAgdmFyIGNmZyA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGxvZywgJ3V0ZjgnKSk7XG4gICAgICAgIHNldENvbmZpZyhjZmcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignY2FuIG5vdCBjb25maWd1cmUgbG9nZ2luZyB1c2luZyBjbGkgcGFyYW0gdmFsdWU6ICcgKyBsb2cpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuZnVuY3Rpb24gYWRkTG9nZ2VyKGxhYmVsLCBsZXZlbD86IHN0cmluZyk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2Uge1xuXG4gIGxldmVsID0gbGV2ZWwgPyBsZXZlbCA6IGNvbmZpZ1snZGVmYXVsdCddIHx8ICdpbmZvJztcbiAgbGV0IGNmZyA9IG1rTG9nQ29uZmlnKGxhYmVsLCBsZXZlbCk7XG4gIGxldCBsb2dnZXI7XG4gIGlmICh3aW5zdG9uLmxvZ2dlcnMuaGFzKGxhYmVsKSkge1xuICAgIGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5nZXQobGFiZWwpO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHt9KTtcbiAgfVxuXG4gIGxvZ2dlci5jb25maWd1cmUoY2ZnKTtcbiAgcmV0dXJuIGxvZ2dlcjtcbn1cblxuLyoqIGdldCBhIGxvZ2dlciBhbmQgZ2l2ZSBpdCBhIG5hbWUgKi9cbmV4cG9ydCBjb25zdCBnZXRMb2dnZXIgPSAoaWQ6IHN0cmluZyk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2UgPT4ge1xuICB2YXIgZXhpc3RpbmcgPSB3aW5zdG9uLmxvZ2dlcnMuaGFzKGlkKTtcblxuICBpZiAoZXhpc3RpbmcpIHtcbiAgICByZXR1cm4gd2luc3Rvbi5sb2dnZXJzLmdldChpZCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGFkZExvZ2dlcihpZCwgY29uZmlnW2lkXSB8fCBjb25maWdbJ2RlZmF1bHQnXSk7XG4gIH1cbn07XG5cbi8qKiBnZXQgYSBsb2dnZXIgYW5kIG5hbWUgaXQgYnkgaXQncyBmaWxlIG5hbWUuICovXG5leHBvcnQgY29uc3QgZmlsZUxvZ2dlciA9IChmaWxlbmFtZSk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2UgPT4ge1xuICB2YXIgbGFiZWw7XG4gIHZhciBwYXJzZWQgPSBwYXRoLnBhcnNlKGZpbGVuYW1lKTtcblxuICBpZiAocGFyc2VkLm5hbWUgPT09ICdpbmRleCcpIHtcbiAgICBsYWJlbCA9IHBhdGguYmFzZW5hbWUocGFyc2VkLmRpcik7XG4gIH0gZWxzZSB7XG4gICAgbGFiZWwgPSBwYXJzZWQubmFtZTtcbiAgfVxuICByZXR1cm4gZ2V0TG9nZ2VyKGxhYmVsKTtcbn07XG5cbi8qKlxuICogQ3JlYXRlIGEgbG9nZ2VyIGFuZCBhdXRvbWF0aWNhbGx5IG5hbWUgaXQgYnkgdXNpbmcgdGhlIGZpbGVuYW1lIG9mIHRoZSBjYWxsIHNpdGUuXG4gKiBFZzpcbiAqIGBgYFxuICogLy9teS1maWxlLmpzXG4gKiBpbXBvcnQge2J1aWxkTG9nZ2VyfSBmcm9tICdsb2ctZmFjdG9yeSc7XG4gKiBsZXQgbG9nZ2VyID0gYnVpbGRMb2dnZXIoKTtcbiAqIGxvZ2dlci5pbmZvKCdoaScpIC8vPT4gZW1pdHMgW0lORk9dIFtteS1maWxlXSBoaVxuICogYGBgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBidWlsZExvZ2dlcigpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlIHtcbiAgbGV0IHRyYWNlID0gc3RhY2tUcmFjZS5nZXQoKTtcbiAgbGV0IG5hbWUgPSB0cmFjZVsxXS5nZXRGaWxlTmFtZSgpO1xuICByZXR1cm4gZmlsZUxvZ2dlcihuYW1lKTtcbn1cbiJdfQ==
