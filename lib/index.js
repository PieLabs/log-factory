"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const dateFormat = require("dateformat");
const fs = require("fs");
const path = require("path");
const stackTrace = require("stack-trace");
const winston = require("winston");
const moduleOpts = {
    console: true,
    file: null,
    log: 'info'
};
let config = {
    'default': 'info'
};
const timestamp = () => {
    var now = new Date();
    return dateFormat(now, 'HH:MM:ss.l');
};
const consoleTransport = (label) => {
    return new (winston.transports.Console)({
        colorize: true,
        label: label,
        timestamp
    });
};
const fileTransport = (label) => {
    return new winston.transports.File({
        colorize: false,
        json: false,
        filename: moduleOpts.file,
        label,
        timestamp
    });
};
const mkLogConfig = (label, level) => {
    const addConsole = !moduleOpts.file && moduleOpts.console;
    const transports = [
        addConsole ? consoleTransport(label) : null,
        moduleOpts.file ? fileTransport(label) : null
    ].filter(t => t !== null);
    return { level, transports };
};
const setConfig = (cfg) => {
    config = _.merge({}, config, cfg);
    _.forIn(cfg, (value, key) => {
        addLogger(key, value);
    });
};
const isLogLevel = (l) => _.includes(['error', 'warn', 'info', 'verbose', 'debug', 'silly'], l);
exports.setDefaultLevel = (l) => {
    config = _.merge(config, { 'default': l });
    _.forEach(winston.loggers.loggers, (value, key) => {
        let logger = winston.loggers.get(key);
        let cfg = mkLogConfig(key, config['default']);
        logger.configure(cfg);
    });
};
exports.init = (opts) => {
    moduleOpts.console = opts.console;
    moduleOpts.file = opts.file;
    moduleOpts.log = opts.log || moduleOpts.log;
    const { log } = moduleOpts;
    if (!log) {
        return;
    }
    if (_.isObject(log)) {
        setConfig(log);
    }
    else if (isLogLevel(log)) {
        exports.setDefaultLevel(log);
    }
    else {
        try {
            let config = JSON.parse(log);
            setConfig(config);
        }
        catch (e) {
            if (fs.existsSync(log)) {
                var cfg = JSON.parse(fs.readFileSync(log, 'utf8'));
                setConfig(cfg);
            }
            else {
                console.error('can not configure logging using cli param value: ' + log);
            }
        }
    }
};
function addLogger(label, level) {
    level = level ? level : config['default'] || 'info';
    let cfg = mkLogConfig(label, level);
    let logger;
    if (winston.loggers.has(label)) {
        logger = winston.loggers.get(label);
    }
    else {
        logger = winston.loggers.add(label, {});
    }
    logger.configure(cfg);
    return logger;
}
exports.getLogger = (id) => {
    var existing = winston.loggers.has(id);
    if (existing) {
        return winston.loggers.get(id);
    }
    else {
        return addLogger(id, config[id] || config['default']);
    }
};
exports.fileLogger = (filename) => {
    var label;
    var parsed = path.parse(filename);
    if (parsed.name === 'index') {
        label = path.basename(parsed.dir);
    }
    else {
        label = parsed.name;
    }
    return exports.getLogger(label);
};
function buildLogger() {
    let trace = stackTrace.get();
    let name = trace[1].getFileName();
    return exports.fileLogger(name);
}
exports.buildLogger = buildLogger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRCQUE0QjtBQUM1Qix5Q0FBeUM7QUFDekMseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3QiwwQ0FBMEM7QUFDMUMsbUNBQW1DO0FBVW5DLE1BQU0sVUFBVSxHQUFHO0lBQ2pCLE9BQU8sRUFBRSxJQUFJO0lBQ2IsSUFBSSxFQUFFLElBQUk7SUFDVixHQUFHLEVBQUUsTUFBTTtDQUNaLENBQUM7QUFFRixJQUFJLE1BQU0sR0FBRztJQUNYLFNBQVMsRUFBRSxNQUFNO0NBQ2xCLENBQUM7QUFFRixNQUFNLFNBQVMsR0FBRztJQUNoQixJQUFJLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ3JCLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ3ZDLENBQUMsQ0FBQztBQUVGLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFhO0lBQ3JDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0QyxRQUFRLEVBQUUsSUFBSTtRQUNkLEtBQUssRUFBRSxLQUFLO1FBQ1osU0FBUztLQUNWLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUVGLE1BQU0sYUFBYSxHQUFHLENBQUMsS0FBYTtJQUNsQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztRQUNqQyxRQUFRLEVBQUUsS0FBSztRQUNmLElBQUksRUFBRSxLQUFLO1FBQ1gsUUFBUSxFQUFFLFVBQVUsQ0FBQyxJQUFJO1FBQ3pCLEtBQUs7UUFDTCxTQUFTO0tBQ1YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRUYsTUFBTSxXQUFXLEdBQUcsQ0FBQyxLQUFhLEVBQUUsS0FBYTtJQUUvQyxNQUFNLFVBQVUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQztJQUUxRCxNQUFNLFVBQVUsR0FBZ0M7UUFDOUMsVUFBVSxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUk7UUFDM0MsVUFBVSxDQUFDLElBQUksR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSTtLQUM5QyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO0lBRzFCLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsQ0FBQztBQUMvQixDQUFDLENBQUM7QUFHRixNQUFNLFNBQVMsR0FBRyxDQUFDLEdBQUc7SUFDcEIsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNsQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHO1FBQ3RCLFNBQVMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDeEIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFFRixNQUFNLFVBQVUsR0FBRyxDQUFDLENBQUMsS0FBYyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUU1RixRQUFBLGVBQWUsR0FBRyxDQUFDLENBQUM7SUFDL0IsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHO1FBQzVDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLElBQUksR0FBRyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDOUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUVXLFFBQUEsSUFBSSxHQUFHLENBQUMsSUFBb0I7SUFFdkMsVUFBVSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ2xDLFVBQVUsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztJQUM1QixVQUFVLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQztJQUU1QyxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsVUFBVSxDQUFDO0lBRTNCLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNULE1BQU0sQ0FBQztJQUNULENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakIsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNCLHVCQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sSUFBSSxDQUFDO1lBQ0gsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM3QixTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDcEIsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDWCxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdkIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNuRCxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE9BQU8sQ0FBQyxLQUFLLENBQUMsbURBQW1ELEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDM0UsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsbUJBQW1CLEtBQUssRUFBRSxLQUFjO0lBRXRDLEtBQUssR0FBRyxLQUFLLEdBQUcsS0FBSyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUM7SUFDcEQsSUFBSSxHQUFHLEdBQUcsV0FBVyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwQyxJQUFJLE1BQU0sQ0FBQztJQUNYLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QixNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFHWSxRQUFBLFNBQVMsR0FBRyxDQUFDLEVBQVU7SUFDbEMsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFdkMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNiLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztBQUNILENBQUMsQ0FBQztBQUdXLFFBQUEsVUFBVSxHQUFHLENBQUMsUUFBUTtJQUNqQyxJQUFJLEtBQUssQ0FBQztJQUNWLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFbEMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQzVCLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztJQUN0QixDQUFDO0lBQ0QsTUFBTSxDQUFDLGlCQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDMUIsQ0FBQyxDQUFDO0FBWUY7SUFDRSxJQUFJLEtBQUssR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDN0IsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLE1BQU0sQ0FBQyxrQkFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzFCLENBQUM7QUFKRCxrQ0FJQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGRhdGVGb3JtYXQgZnJvbSAnZGF0ZWZvcm1hdCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgc3RhY2tUcmFjZSBmcm9tICdzdGFjay10cmFjZSc7XG5pbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuXG4vL2xldmVsczogZXJyb3IgPiB3YXJuID4gaW5mbyA+IHZlcmJvc2UgPiBkZWJ1ZyA+IHNpbGx5XG5cbnR5cGUgTG9nRmFjdG9yeU9wdHMgPSB7XG4gIGNvbnNvbGU6IGJvb2xlYW4sXG4gIGZpbGU/OiBzdHJpbmcsXG4gIGxvZz86IGFueVxufTtcblxuY29uc3QgbW9kdWxlT3B0cyA9IHtcbiAgY29uc29sZTogdHJ1ZSxcbiAgZmlsZTogbnVsbCxcbiAgbG9nOiAnaW5mbydcbn07XG5cbmxldCBjb25maWcgPSB7XG4gICdkZWZhdWx0JzogJ2luZm8nXG59O1xuXG5jb25zdCB0aW1lc3RhbXAgPSAoKSA9PiB7XG4gIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xuICByZXR1cm4gZGF0ZUZvcm1hdChub3csICdISDpNTTpzcy5sJyk7XG59O1xuXG5jb25zdCBjb25zb2xlVHJhbnNwb3J0ID0gKGxhYmVsOiBzdHJpbmcpOiB3aW5zdG9uLlRyYW5zcG9ydEluc3RhbmNlID0+IHtcbiAgcmV0dXJuIG5ldyAod2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUpKHtcbiAgICBjb2xvcml6ZTogdHJ1ZSxcbiAgICBsYWJlbDogbGFiZWwsXG4gICAgdGltZXN0YW1wXG4gIH0pO1xufTtcblxuY29uc3QgZmlsZVRyYW5zcG9ydCA9IChsYWJlbDogc3RyaW5nKTogd2luc3Rvbi5UcmFuc3BvcnRJbnN0YW5jZSA9PiB7XG4gIHJldHVybiBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkZpbGUoe1xuICAgIGNvbG9yaXplOiBmYWxzZSxcbiAgICBqc29uOiBmYWxzZSxcbiAgICBmaWxlbmFtZTogbW9kdWxlT3B0cy5maWxlLFxuICAgIGxhYmVsLFxuICAgIHRpbWVzdGFtcFxuICB9KTtcbn07XG5cbmNvbnN0IG1rTG9nQ29uZmlnID0gKGxhYmVsOiBzdHJpbmcsIGxldmVsOiBzdHJpbmcpID0+IHtcblxuICBjb25zdCBhZGRDb25zb2xlID0gIW1vZHVsZU9wdHMuZmlsZSAmJiBtb2R1bGVPcHRzLmNvbnNvbGU7XG5cbiAgY29uc3QgdHJhbnNwb3J0czogd2luc3Rvbi5UcmFuc3BvcnRJbnN0YW5jZVtdID0gW1xuICAgIGFkZENvbnNvbGUgPyBjb25zb2xlVHJhbnNwb3J0KGxhYmVsKSA6IG51bGwsXG4gICAgbW9kdWxlT3B0cy5maWxlID8gZmlsZVRyYW5zcG9ydChsYWJlbCkgOiBudWxsXG4gIF0uZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCk7XG5cblxuICByZXR1cm4geyBsZXZlbCwgdHJhbnNwb3J0cyB9O1xufTtcblxuXG5jb25zdCBzZXRDb25maWcgPSAoY2ZnKSA9PiB7XG4gIGNvbmZpZyA9IF8ubWVyZ2Uoe30sIGNvbmZpZywgY2ZnKTtcbiAgXy5mb3JJbihjZmcsICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgYWRkTG9nZ2VyKGtleSwgdmFsdWUpO1xuICB9KTtcbn07XG5cbmNvbnN0IGlzTG9nTGV2ZWwgPSAobCk6IEJvb2xlYW4gPT4gXy5pbmNsdWRlcyhbJ2Vycm9yJywgJ3dhcm4nLCAnaW5mbycsICd2ZXJib3NlJywgJ2RlYnVnJywgJ3NpbGx5J10sIGwpO1xuXG5leHBvcnQgY29uc3Qgc2V0RGVmYXVsdExldmVsID0gKGwpID0+IHtcbiAgY29uZmlnID0gXy5tZXJnZShjb25maWcsIHsgJ2RlZmF1bHQnOiBsIH0pO1xuICBfLmZvckVhY2god2luc3Rvbi5sb2dnZXJzLmxvZ2dlcnMsICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgbGV0IGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5nZXQoa2V5KTtcbiAgICBsZXQgY2ZnID0gbWtMb2dDb25maWcoa2V5LCBjb25maWdbJ2RlZmF1bHQnXSk7XG4gICAgbG9nZ2VyLmNvbmZpZ3VyZShjZmcpO1xuICB9KTtcbn07XG5cbmV4cG9ydCBjb25zdCBpbml0ID0gKG9wdHM6IExvZ0ZhY3RvcnlPcHRzKTogdm9pZCA9PiB7XG5cbiAgbW9kdWxlT3B0cy5jb25zb2xlID0gb3B0cy5jb25zb2xlO1xuICBtb2R1bGVPcHRzLmZpbGUgPSBvcHRzLmZpbGU7XG4gIG1vZHVsZU9wdHMubG9nID0gb3B0cy5sb2cgfHwgbW9kdWxlT3B0cy5sb2c7XG5cbiAgY29uc3QgeyBsb2cgfSA9IG1vZHVsZU9wdHM7XG5cbiAgaWYgKCFsb2cpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoXy5pc09iamVjdChsb2cpKSB7XG4gICAgc2V0Q29uZmlnKGxvZyk7XG4gIH0gZWxzZSBpZiAoaXNMb2dMZXZlbChsb2cpKSB7XG4gICAgc2V0RGVmYXVsdExldmVsKGxvZyk7XG4gIH0gZWxzZSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBjb25maWcgPSBKU09OLnBhcnNlKGxvZyk7XG4gICAgICBzZXRDb25maWcoY29uZmlnKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhsb2cpKSB7XG4gICAgICAgIHZhciBjZmcgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhsb2csICd1dGY4JykpO1xuICAgICAgICBzZXRDb25maWcoY2ZnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ2NhbiBub3QgY29uZmlndXJlIGxvZ2dpbmcgdXNpbmcgY2xpIHBhcmFtIHZhbHVlOiAnICsgbG9nKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGFkZExvZ2dlcihsYWJlbCwgbGV2ZWw/OiBzdHJpbmcpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlIHtcblxuICBsZXZlbCA9IGxldmVsID8gbGV2ZWwgOiBjb25maWdbJ2RlZmF1bHQnXSB8fCAnaW5mbyc7XG4gIGxldCBjZmcgPSBta0xvZ0NvbmZpZyhsYWJlbCwgbGV2ZWwpO1xuICBsZXQgbG9nZ2VyO1xuICBpZiAod2luc3Rvbi5sb2dnZXJzLmhhcyhsYWJlbCkpIHtcbiAgICBsb2dnZXIgPSB3aW5zdG9uLmxvZ2dlcnMuZ2V0KGxhYmVsKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIgPSB3aW5zdG9uLmxvZ2dlcnMuYWRkKGxhYmVsLCB7fSk7XG4gIH1cblxuICBsb2dnZXIuY29uZmlndXJlKGNmZyk7XG4gIHJldHVybiBsb2dnZXI7XG59XG5cbi8qKiBnZXQgYSBsb2dnZXIgYW5kIGdpdmUgaXQgYSBuYW1lICovXG5leHBvcnQgY29uc3QgZ2V0TG9nZ2VyID0gKGlkOiBzdHJpbmcpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlID0+IHtcbiAgdmFyIGV4aXN0aW5nID0gd2luc3Rvbi5sb2dnZXJzLmhhcyhpZCk7XG5cbiAgaWYgKGV4aXN0aW5nKSB7XG4gICAgcmV0dXJuIHdpbnN0b24ubG9nZ2Vycy5nZXQoaWQpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhZGRMb2dnZXIoaWQsIGNvbmZpZ1tpZF0gfHwgY29uZmlnWydkZWZhdWx0J10pO1xuICB9XG59O1xuXG4vKiogZ2V0IGEgbG9nZ2VyIGFuZCBuYW1lIGl0IGJ5IGl0J3MgZmlsZSBuYW1lLiAqL1xuZXhwb3J0IGNvbnN0IGZpbGVMb2dnZXIgPSAoZmlsZW5hbWUpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlID0+IHtcbiAgdmFyIGxhYmVsO1xuICB2YXIgcGFyc2VkID0gcGF0aC5wYXJzZShmaWxlbmFtZSk7XG5cbiAgaWYgKHBhcnNlZC5uYW1lID09PSAnaW5kZXgnKSB7XG4gICAgbGFiZWwgPSBwYXRoLmJhc2VuYW1lKHBhcnNlZC5kaXIpO1xuICB9IGVsc2Uge1xuICAgIGxhYmVsID0gcGFyc2VkLm5hbWU7XG4gIH1cbiAgcmV0dXJuIGdldExvZ2dlcihsYWJlbCk7XG59O1xuXG4vKipcbiAqIENyZWF0ZSBhIGxvZ2dlciBhbmQgYXV0b21hdGljYWxseSBuYW1lIGl0IGJ5IHVzaW5nIHRoZSBmaWxlbmFtZSBvZiB0aGUgY2FsbCBzaXRlLlxuICogRWc6XG4gKiBgYGBcbiAqIC8vbXktZmlsZS5qc1xuICogaW1wb3J0IHtidWlsZExvZ2dlcn0gZnJvbSAnbG9nLWZhY3RvcnknO1xuICogbGV0IGxvZ2dlciA9IGJ1aWxkTG9nZ2VyKCk7XG4gKiBsb2dnZXIuaW5mbygnaGknKSAvLz0+IGVtaXRzIFtJTkZPXSBbbXktZmlsZV0gaGlcbiAqIGBgYFxuICovXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRMb2dnZXIoKTogd2luc3Rvbi5Mb2dnZXJJbnN0YW5jZSB7XG4gIGxldCB0cmFjZSA9IHN0YWNrVHJhY2UuZ2V0KCk7XG4gIGxldCBuYW1lID0gdHJhY2VbMV0uZ2V0RmlsZU5hbWUoKTtcbiAgcmV0dXJuIGZpbGVMb2dnZXIobmFtZSk7XG59XG4iXX0=
