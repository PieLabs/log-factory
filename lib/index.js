"use strict";
const _ = require("lodash");
const dateFormat = require("dateformat");
const fs = require("fs");
const path = require("path");
const stackTrace = require("stack-trace");
const winston = require("winston");
const moduleOpts = {
    console: true,
    file: null,
    log: 'INFO'
};
let config = {
    'default': 'info'
};
const timestamp = () => {
    var now = new Date();
    return dateFormat(now, 'HH:MM:ss.l');
};
const consoleTransport = (label) => {
    return new (winston.transports.Console)({
        colorize: true,
        label: label,
        timestamp
    });
};
const fileTransport = (label) => {
    return new winston.transports.File({
        colorize: false,
        json: false,
        filename: moduleOpts.file,
        label,
        timestamp
    });
};
const mkLogConfig = (label, level) => {
    const addConsole = !moduleOpts.file && moduleOpts.console;
    const transports = [
        addConsole ? consoleTransport(label) : null,
        moduleOpts.file ? fileTransport(label) : null
    ].filter(t => t !== null);
    return { level, transports };
};
const logger = addLogger('LOG_FACTORY');
const setConfig = (cfg) => {
    config = _.merge({}, config, cfg);
    _.forIn(cfg, (value, key) => {
        addLogger(key, value);
    });
};
const isLogLevel = (l) => _.includes(['error', 'warn', 'info', 'verbose', 'debug', 'silly'], l);
exports.setDefaultLevel = (l) => {
    config = _.merge(config, { 'default': l });
    logger.debug('default level now: ', config['default']);
    _.forEach(winston.loggers.loggers, (value, key) => {
        let logger = winston.loggers.get(key);
        let cfg = mkLogConfig(key, config['default']);
        logger.configure(cfg);
    });
};
exports.init = (opts) => {
    logger.debug('init: ', opts);
    moduleOpts.console = opts.console;
    moduleOpts.file = opts.file;
    moduleOpts.log = opts.log;
    const { log } = moduleOpts;
    if (!log) {
        return;
    }
    if (_.isObject(log)) {
        setConfig(log);
    }
    else if (isLogLevel(log)) {
        exports.setDefaultLevel(log);
    }
    else {
        try {
            let config = JSON.parse(log);
            logger.debug('parsed log: ', log);
            setConfig(config);
        }
        catch (e) {
            if (fs.existsSync(log)) {
                var cfg = JSON.parse(fs.readFileSync(log, 'utf8'));
                setConfig(cfg);
            }
            else {
                console.error('can not configure logging using cli param value: ' + log);
            }
        }
    }
};
function addLogger(label, level) {
    level = level ? level : config['default'] || 'info';
    let cfg = mkLogConfig(label, level);
    let logger;
    if (winston.loggers.has(label)) {
        logger = winston.loggers.get(label);
    }
    else {
        logger = winston.loggers.add(label, {});
    }
    logger.configure(cfg);
    return logger;
}
exports.getLogger = (id) => {
    var existing = winston.loggers.has(id);
    if (existing) {
        return winston.loggers.get(id);
    }
    else {
        return addLogger(id, config[id] || config['default']);
    }
};
exports.fileLogger = (filename) => {
    var label;
    var parsed = path.parse(filename);
    if (parsed.name === 'index') {
        label = path.basename(parsed.dir);
    }
    else {
        label = parsed.name;
    }
    return exports.getLogger(label);
};
function buildLogger() {
    let trace = stackTrace.get();
    let name = trace[1].getFileName();
    return exports.fileLogger(name);
}
exports.buildLogger = buildLogger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGRhdGVGb3JtYXQgZnJvbSAnZGF0ZWZvcm1hdCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgc3RhY2tUcmFjZSBmcm9tICdzdGFjay10cmFjZSc7XG5pbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuXG4vL2xldmVsczogZXJyb3IgPiB3YXJuID4gaW5mbyA+IHZlcmJvc2UgPiBkZWJ1ZyA+IHNpbGx5XG5cbnR5cGUgTG9nRmFjdG9yeU9wdHMgPSB7XG4gIGNvbnNvbGU6IGJvb2xlYW4sXG4gIGZpbGU/OiBzdHJpbmcsXG4gIGxvZz86IGFueVxufTtcblxuY29uc3QgbW9kdWxlT3B0cyA9IHtcbiAgY29uc29sZTogdHJ1ZSxcbiAgZmlsZTogbnVsbCxcbiAgbG9nOiAnSU5GTydcbn07XG5cbmxldCBjb25maWcgPSB7XG4gICdkZWZhdWx0JzogJ2luZm8nXG59O1xuXG5jb25zdCB0aW1lc3RhbXAgPSAoKSA9PiB7XG4gIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xuICByZXR1cm4gZGF0ZUZvcm1hdChub3csICdISDpNTTpzcy5sJyk7XG59O1xuXG5jb25zdCBjb25zb2xlVHJhbnNwb3J0ID0gKGxhYmVsOiBzdHJpbmcpOiB3aW5zdG9uLlRyYW5zcG9ydEluc3RhbmNlID0+IHtcbiAgcmV0dXJuIG5ldyAod2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUpKHtcbiAgICBjb2xvcml6ZTogdHJ1ZSxcbiAgICBsYWJlbDogbGFiZWwsXG4gICAgdGltZXN0YW1wXG4gIH0pO1xufTtcblxuY29uc3QgZmlsZVRyYW5zcG9ydCA9IChsYWJlbDogc3RyaW5nKTogd2luc3Rvbi5UcmFuc3BvcnRJbnN0YW5jZSA9PiB7XG4gIHJldHVybiBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkZpbGUoe1xuICAgIGNvbG9yaXplOiBmYWxzZSxcbiAgICBqc29uOiBmYWxzZSxcbiAgICBmaWxlbmFtZTogbW9kdWxlT3B0cy5maWxlLFxuICAgIGxhYmVsLFxuICAgIHRpbWVzdGFtcFxuICB9KTtcbn07XG5cbmNvbnN0IG1rTG9nQ29uZmlnID0gKGxhYmVsOiBzdHJpbmcsIGxldmVsOiBzdHJpbmcpID0+IHtcblxuICBjb25zdCBhZGRDb25zb2xlID0gIW1vZHVsZU9wdHMuZmlsZSAmJiBtb2R1bGVPcHRzLmNvbnNvbGU7XG5cbiAgY29uc3QgdHJhbnNwb3J0czogd2luc3Rvbi5UcmFuc3BvcnRJbnN0YW5jZVtdID0gW1xuICAgIGFkZENvbnNvbGUgPyBjb25zb2xlVHJhbnNwb3J0KGxhYmVsKSA6IG51bGwsXG4gICAgbW9kdWxlT3B0cy5maWxlID8gZmlsZVRyYW5zcG9ydChsYWJlbCkgOiBudWxsXG4gIF0uZmlsdGVyKHQgPT4gdCAhPT0gbnVsbCk7XG5cbiAgcmV0dXJuIHsgbGV2ZWwsIHRyYW5zcG9ydHMgfTtcbn07XG5cbmNvbnN0IGxvZ2dlciA9IGFkZExvZ2dlcignTE9HX0ZBQ1RPUlknKTtcblxuY29uc3Qgc2V0Q29uZmlnID0gKGNmZykgPT4ge1xuICBjb25maWcgPSBfLm1lcmdlKHt9LCBjb25maWcsIGNmZyk7XG4gIF8uZm9ySW4oY2ZnLCAodmFsdWUsIGtleSkgPT4ge1xuICAgIGFkZExvZ2dlcihrZXksIHZhbHVlKTtcbiAgfSk7XG59O1xuXG5jb25zdCBpc0xvZ0xldmVsID0gKGwpOiBCb29sZWFuID0+IF8uaW5jbHVkZXMoWydlcnJvcicsICd3YXJuJywgJ2luZm8nLCAndmVyYm9zZScsICdkZWJ1ZycsICdzaWxseSddLCBsKTtcblxuZXhwb3J0IGNvbnN0IHNldERlZmF1bHRMZXZlbCA9IChsKSA9PiB7XG4gIGNvbmZpZyA9IF8ubWVyZ2UoY29uZmlnLCB7ICdkZWZhdWx0JzogbCB9KTtcbiAgbG9nZ2VyLmRlYnVnKCdkZWZhdWx0IGxldmVsIG5vdzogJywgY29uZmlnWydkZWZhdWx0J10pO1xuICBfLmZvckVhY2god2luc3Rvbi5sb2dnZXJzLmxvZ2dlcnMsICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgbGV0IGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5nZXQoa2V5KTtcbiAgICBsZXQgY2ZnID0gbWtMb2dDb25maWcoa2V5LCBjb25maWdbJ2RlZmF1bHQnXSk7XG4gICAgbG9nZ2VyLmNvbmZpZ3VyZShjZmcpO1xuICB9KTtcbn07XG5cbmV4cG9ydCBjb25zdCBpbml0ID0gKG9wdHM6IExvZ0ZhY3RvcnlPcHRzKTogdm9pZCA9PiB7XG5cbiAgbG9nZ2VyLmRlYnVnKCdpbml0OiAnLCBvcHRzKTtcblxuICBtb2R1bGVPcHRzLmNvbnNvbGUgPSBvcHRzLmNvbnNvbGU7XG4gIG1vZHVsZU9wdHMuZmlsZSA9IG9wdHMuZmlsZTtcbiAgbW9kdWxlT3B0cy5sb2cgPSBvcHRzLmxvZztcblxuICBjb25zdCB7IGxvZyB9ID0gbW9kdWxlT3B0cztcblxuICBpZiAoIWxvZykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChfLmlzT2JqZWN0KGxvZykpIHtcbiAgICBzZXRDb25maWcobG9nKTtcbiAgfSBlbHNlIGlmIChpc0xvZ0xldmVsKGxvZykpIHtcbiAgICBzZXREZWZhdWx0TGV2ZWwobG9nKTtcbiAgfSBlbHNlIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGNvbmZpZyA9IEpTT04ucGFyc2UobG9nKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZygncGFyc2VkIGxvZzogJywgbG9nKTtcbiAgICAgIHNldENvbmZpZyhjb25maWcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKGxvZykpIHtcbiAgICAgICAgdmFyIGNmZyA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGxvZywgJ3V0ZjgnKSk7XG4gICAgICAgIHNldENvbmZpZyhjZmcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignY2FuIG5vdCBjb25maWd1cmUgbG9nZ2luZyB1c2luZyBjbGkgcGFyYW0gdmFsdWU6ICcgKyBsb2cpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuZnVuY3Rpb24gYWRkTG9nZ2VyKGxhYmVsLCBsZXZlbD86IHN0cmluZyk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2Uge1xuXG4gIGxldmVsID0gbGV2ZWwgPyBsZXZlbCA6IGNvbmZpZ1snZGVmYXVsdCddIHx8ICdpbmZvJztcbiAgbGV0IGNmZyA9IG1rTG9nQ29uZmlnKGxhYmVsLCBsZXZlbCk7XG4gIGxldCBsb2dnZXI7XG4gIGlmICh3aW5zdG9uLmxvZ2dlcnMuaGFzKGxhYmVsKSkge1xuICAgIGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5nZXQobGFiZWwpO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHt9KTtcbiAgfVxuXG4gIGxvZ2dlci5jb25maWd1cmUoY2ZnKTtcbiAgcmV0dXJuIGxvZ2dlcjtcbn1cblxuLyoqIGdldCBhIGxvZ2dlciBhbmQgZ2l2ZSBpdCBhIG5hbWUgKi9cbmV4cG9ydCBjb25zdCBnZXRMb2dnZXIgPSAoaWQ6IHN0cmluZyk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2UgPT4ge1xuICB2YXIgZXhpc3RpbmcgPSB3aW5zdG9uLmxvZ2dlcnMuaGFzKGlkKTtcblxuICBpZiAoZXhpc3RpbmcpIHtcbiAgICByZXR1cm4gd2luc3Rvbi5sb2dnZXJzLmdldChpZCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGFkZExvZ2dlcihpZCwgY29uZmlnW2lkXSB8fCBjb25maWdbJ2RlZmF1bHQnXSk7XG4gIH1cbn07XG5cbi8qKiBnZXQgYSBsb2dnZXIgYW5kIG5hbWUgaXQgYnkgaXQncyBmaWxlIG5hbWUuICovXG5leHBvcnQgY29uc3QgZmlsZUxvZ2dlciA9IChmaWxlbmFtZSk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2UgPT4ge1xuICB2YXIgbGFiZWw7XG4gIHZhciBwYXJzZWQgPSBwYXRoLnBhcnNlKGZpbGVuYW1lKTtcblxuICBpZiAocGFyc2VkLm5hbWUgPT09ICdpbmRleCcpIHtcbiAgICBsYWJlbCA9IHBhdGguYmFzZW5hbWUocGFyc2VkLmRpcik7XG4gIH0gZWxzZSB7XG4gICAgbGFiZWwgPSBwYXJzZWQubmFtZTtcbiAgfVxuICByZXR1cm4gZ2V0TG9nZ2VyKGxhYmVsKTtcbn07XG5cbi8qKlxuICogQ3JlYXRlIGEgbG9nZ2VyIGFuZCBhdXRvbWF0aWNhbGx5IG5hbWUgaXQgYnkgdXNpbmcgdGhlIGZpbGVuYW1lIG9mIHRoZSBjYWxsIHNpdGUuXG4gKiBFZzpcbiAqIGBgYFxuICogLy9teS1maWxlLmpzXG4gKiBpbXBvcnQge2J1aWxkTG9nZ2VyfSBmcm9tICdsb2ctZmFjdG9yeSc7XG4gKiBsZXQgbG9nZ2VyID0gYnVpbGRMb2dnZXIoKTtcbiAqIGxvZ2dlci5pbmZvKCdoaScpIC8vPT4gZW1pdHMgW0lORk9dIFtteS1maWxlXSBoaVxuICogYGBgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBidWlsZExvZ2dlcigpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlIHtcbiAgbGV0IHRyYWNlID0gc3RhY2tUcmFjZS5nZXQoKTtcbiAgbGV0IG5hbWUgPSB0cmFjZVsxXS5nZXRGaWxlTmFtZSgpO1xuICByZXR1cm4gZmlsZUxvZ2dlcihuYW1lKTtcbn1cbiJdfQ==
