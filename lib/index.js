"use strict";
const winston = require("winston");
const path = require("path");
const _ = require("lodash");
const fs = require("fs");
const stackTrace = require("stack-trace");
let config = {
    'default': 'info'
};
let mkLogConfig = (label, level) => {
    return {
        level: level,
        transports: [
            new (winston.transports.Console)({ colorize: true, label: label })
        ]
    };
};
const logger = addLogger('LOG_FACTORY');
exports.init = (log) => {
    logger.debug('init: ', log);
    if (!log) {
        return;
    }
    if (_.isObject(log)) {
        setConfig(log);
    }
    else if (isLogLevel(log)) {
        exports.setDefaultLevel(log);
    }
    else {
        try {
            let config = JSON.parse(log);
            logger.debug('parsed log: ', log);
            setConfig(config);
        }
        catch (e) {
            if (fs.existsSync(log)) {
                var cfg = JSON.parse(fs.readFileSync(log, 'utf8'));
                setConfig(cfg);
            }
            else {
                console.error('can not configure logging using cli param value: ' + log);
            }
        }
    }
};
let setConfig = (cfg) => {
    config = _.merge({}, config, cfg);
    _.forIn(cfg, (value, key) => {
        addLogger(key, value);
    });
};
function addLogger(label, level) {
    level = level ? level : config['default'] || 'info';
    let cfg = mkLogConfig(label, level);
    let logger;
    if (winston.loggers.has(label)) {
        logger = winston.loggers.get(label);
    }
    else {
        logger = winston.loggers.add(label, {});
    }
    logger.configure(cfg);
    return logger;
}
let isLogLevel = (l) => _.includes(['error', 'warn', 'info', 'verbose', 'debug', 'silly'], l);
exports.setDefaultLevel = (l) => {
    config = _.merge(config, { 'default': l });
    logger.debug('default level now: ', config['default']);
    _.forEach(winston.loggers.loggers, (value, key) => {
        let logger = winston.loggers.get(key);
        let cfg = mkLogConfig(key, config['default']);
        logger.configure(cfg);
    });
};
exports.getLogger = (id) => {
    var existing = winston.loggers.has(id);
    if (existing) {
        return winston.loggers.get(id);
    }
    else {
        return addLogger(id, config[id] || config['default']);
    }
};
exports.fileLogger = (filename) => {
    var label;
    var parsed = path.parse(filename);
    if (parsed.name === 'index') {
        label = path.basename(parsed.dir);
    }
    else {
        label = parsed.name;
    }
    return exports.getLogger(label);
};
function buildLogger() {
    let trace = stackTrace.get();
    let name = trace[1].getFileName();
    return exports.fileLogger(name);
}
exports.buildLogger = buildLogger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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anMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHN0YWNrVHJhY2UgZnJvbSAnc3RhY2stdHJhY2UnO1xuLy9sZXZlbHM6IGVycm9yID4gd2FybiA+IGluZm8gPiB2ZXJib3NlID4gZGVidWcgPiBzaWxseVxuXG5sZXQgY29uZmlnID0ge1xuICAnZGVmYXVsdCc6ICdpbmZvJ1xufTtcblxubGV0IG1rTG9nQ29uZmlnID0gKGxhYmVsOiBzdHJpbmcsIGxldmVsOiBzdHJpbmcpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBsZXZlbDogbGV2ZWwsXG4gICAgdHJhbnNwb3J0czogW1xuICAgICAgbmV3ICh3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSkoeyBjb2xvcml6ZTogdHJ1ZSwgbGFiZWw6IGxhYmVsIH0pXG4gICAgXVxuICB9XG59XG5cbmNvbnN0IGxvZ2dlciA9IGFkZExvZ2dlcignTE9HX0ZBQ1RPUlknKTtcblxuZXhwb3J0IGxldCBpbml0ID0gKGxvZyk6IHZvaWQgPT4ge1xuXG4gIGxvZ2dlci5kZWJ1ZygnaW5pdDogJywgbG9nKTtcblxuICBpZiAoIWxvZykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChfLmlzT2JqZWN0KGxvZykpIHtcbiAgICBzZXRDb25maWcobG9nKTtcbiAgfSBlbHNlIGlmIChpc0xvZ0xldmVsKGxvZykpIHtcbiAgICBzZXREZWZhdWx0TGV2ZWwobG9nKTtcbiAgfSBlbHNlIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGNvbmZpZyA9IEpTT04ucGFyc2UobG9nKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZygncGFyc2VkIGxvZzogJywgbG9nKTtcbiAgICAgIHNldENvbmZpZyhjb25maWcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKGxvZykpIHtcbiAgICAgICAgdmFyIGNmZyA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGxvZywgJ3V0ZjgnKSk7XG4gICAgICAgIHNldENvbmZpZyhjZmcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignY2FuIG5vdCBjb25maWd1cmUgbG9nZ2luZyB1c2luZyBjbGkgcGFyYW0gdmFsdWU6ICcgKyBsb2cpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxubGV0IHNldENvbmZpZyA9IChjZmcpID0+IHtcbiAgY29uZmlnID0gXy5tZXJnZSh7fSwgY29uZmlnLCBjZmcpO1xuICBfLmZvckluKGNmZywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICBhZGRMb2dnZXIoa2V5LCB2YWx1ZSk7XG4gIH0pO1xufTtcblxuZnVuY3Rpb24gYWRkTG9nZ2VyKGxhYmVsLCBsZXZlbD86IHN0cmluZyk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2Uge1xuICBsZXZlbCA9IGxldmVsID8gbGV2ZWwgOiBjb25maWdbJ2RlZmF1bHQnXSB8fCAnaW5mbyc7XG4gIGxldCBjZmcgPSBta0xvZ0NvbmZpZyhsYWJlbCwgbGV2ZWwpO1xuICBsZXQgbG9nZ2VyO1xuICBpZiAod2luc3Rvbi5sb2dnZXJzLmhhcyhsYWJlbCkpIHtcbiAgICBsb2dnZXIgPSB3aW5zdG9uLmxvZ2dlcnMuZ2V0KGxhYmVsKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIgPSB3aW5zdG9uLmxvZ2dlcnMuYWRkKGxhYmVsLCB7fSk7XG4gIH1cblxuICBsb2dnZXIuY29uZmlndXJlKGNmZyk7XG4gIHJldHVybiBsb2dnZXI7XG59XG5cblxubGV0IGlzTG9nTGV2ZWwgPSAobCk6IEJvb2xlYW4gPT4gXy5pbmNsdWRlcyhbJ2Vycm9yJywgJ3dhcm4nLCAnaW5mbycsICd2ZXJib3NlJywgJ2RlYnVnJywgJ3NpbGx5J10sIGwpO1xuXG5cbmV4cG9ydCBsZXQgc2V0RGVmYXVsdExldmVsID0gKGwpID0+IHtcbiAgY29uZmlnID0gXy5tZXJnZShjb25maWcsIHsgJ2RlZmF1bHQnOiBsIH0pO1xuICBsb2dnZXIuZGVidWcoJ2RlZmF1bHQgbGV2ZWwgbm93OiAnLCBjb25maWdbJ2RlZmF1bHQnXSk7XG4gIF8uZm9yRWFjaCh3aW5zdG9uLmxvZ2dlcnMubG9nZ2VycywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICBsZXQgbG9nZ2VyID0gd2luc3Rvbi5sb2dnZXJzLmdldChrZXkpO1xuICAgIGxldCBjZmcgPSBta0xvZ0NvbmZpZyhrZXksIGNvbmZpZ1snZGVmYXVsdCddKTtcbiAgICBsb2dnZXIuY29uZmlndXJlKGNmZyk7XG4gIH0pO1xufTtcblxuXG4vKiogZ2V0IGEgbG9nZ2VyIGFuZCBnaXZlIGl0IGEgbmFtZSAqL1xuZXhwb3J0IGxldCBnZXRMb2dnZXIgPSAoaWQ6IHN0cmluZyk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2UgPT4ge1xuICB2YXIgZXhpc3RpbmcgPSB3aW5zdG9uLmxvZ2dlcnMuaGFzKGlkKTtcblxuICBpZiAoZXhpc3RpbmcpIHtcbiAgICByZXR1cm4gd2luc3Rvbi5sb2dnZXJzLmdldChpZCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGFkZExvZ2dlcihpZCwgY29uZmlnW2lkXSB8fCBjb25maWdbJ2RlZmF1bHQnXSk7XG4gIH1cbn07XG5cbi8qKiBnZXQgYSBsb2dnZXIgYW5kIG5hbWUgaXQgYnkgaXQncyBmaWxlIG5hbWUuICovXG5leHBvcnQgbGV0IGZpbGVMb2dnZXIgPSAoZmlsZW5hbWUpOiB3aW5zdG9uLkxvZ2dlckluc3RhbmNlID0+IHtcbiAgdmFyIGxhYmVsO1xuICB2YXIgcGFyc2VkID0gcGF0aC5wYXJzZShmaWxlbmFtZSk7XG5cbiAgaWYgKHBhcnNlZC5uYW1lID09PSAnaW5kZXgnKSB7XG4gICAgbGFiZWwgPSBwYXRoLmJhc2VuYW1lKHBhcnNlZC5kaXIpO1xuICB9IGVsc2Uge1xuICAgIGxhYmVsID0gcGFyc2VkLm5hbWU7XG4gIH1cbiAgcmV0dXJuIGdldExvZ2dlcihsYWJlbCk7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgbG9nZ2VyIGFuZCBhdXRvbWF0aWNhbGx5IG5hbWUgaXQgYnkgdXNpbmcgdGhlIGZpbGVuYW1lIG9mIHRoZSBjYWxsIHNpdGUuXG4gKiBFZzogXG4gKiBgYGBcbiAqIC8vbXktZmlsZS5qc1xuICogaW1wb3J0IHtidWlsZExvZ2dlcn0gZnJvbSAnbG9nLWZhY3RvcnknO1xuICogbGV0IGxvZ2dlciA9IGJ1aWxkTG9nZ2VyKCk7XG4gKiBsb2dnZXIuaW5mbygnaGknKSAvLz0+IGVtaXRzIFtJTkZPXSBbbXktZmlsZV0gaGkgXG4gKiBgYGBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkTG9nZ2VyKCk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2Uge1xuICBsZXQgdHJhY2UgPSBzdGFja1RyYWNlLmdldCgpO1xuICBsZXQgbmFtZSA9IHRyYWNlWzFdLmdldEZpbGVOYW1lKCk7XG4gIHJldHVybiBmaWxlTG9nZ2VyKG5hbWUpO1xufVxuXG5cbiJdfQ==
