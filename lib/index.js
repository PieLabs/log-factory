"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const winston = require("winston");
const path = require("path");
const _ = require("lodash");
const fs = require("fs");
const stackTrace = require("stack-trace");
let config = {
    'default': 'info'
};
let mkLogConfig = (label, level) => {
    return {
        level: level,
        transports: [
            new (winston.transports.Console)({ colorize: true, label: label, timestamp: true })
        ]
    };
};
const logger = addLogger('LOG_FACTORY');
exports.init = (log) => {
    logger.debug('init: ', log);
    if (!log) {
        return;
    }
    if (_.isObject(log)) {
        setConfig(log);
    }
    else if (isLogLevel(log)) {
        exports.setDefaultLevel(log);
    }
    else {
        try {
            let config = JSON.parse(log);
            logger.debug('parsed log: ', log);
            setConfig(config);
        }
        catch (e) {
            if (fs.existsSync(log)) {
                var cfg = JSON.parse(fs.readFileSync(log, 'utf8'));
                setConfig(cfg);
            }
            else {
                console.error('can not configure logging using cli param value: ' + log);
            }
        }
    }
};
let setConfig = (cfg) => {
    config = _.merge({}, config, cfg);
    _.forIn(cfg, (value, key) => {
        addLogger(key, value);
    });
};
function addLogger(label, level) {
    level = level ? level : config['default'] || 'info';
    let cfg = mkLogConfig(label, level);
    let logger;
    if (winston.loggers.has(label)) {
        logger = winston.loggers.get(label);
    }
    else {
        logger = winston.loggers.add(label, {});
    }
    logger.configure(cfg);
    return logger;
}
let isLogLevel = (l) => _.includes(['error', 'warn', 'info', 'verbose', 'debug', 'silly'], l);
exports.setDefaultLevel = (l) => {
    config = _.merge(config, { 'default': l });
    logger.debug('default level now: ', config['default']);
    _.forEach(winston.loggers.loggers, (value, key) => {
        let logger = winston.loggers.get(key);
        let cfg = mkLogConfig(key, config['default']);
        logger.configure(cfg);
    });
};
exports.getLogger = (id) => {
    var existing = winston.loggers.has(id);
    if (existing) {
        return winston.loggers.get(id);
    }
    else {
        return addLogger(id, config[id] || config['default']);
    }
};
exports.fileLogger = (filename) => {
    var label;
    var parsed = path.parse(filename);
    if (parsed.name === 'index') {
        label = path.basename(parsed.dir);
    }
    else {
        label = parsed.name;
    }
    return exports.getLogger(label);
};
function buildLogger() {
    let trace = stackTrace.get();
    let name = trace[1].getFileName();
    return exports.fileLogger(name);
}
exports.buildLogger = buildLogger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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a0NBSUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHN0YWNrVHJhY2UgZnJvbSAnc3RhY2stdHJhY2UnO1xuLy9sZXZlbHM6IGVycm9yID4gd2FybiA+IGluZm8gPiB2ZXJib3NlID4gZGVidWcgPiBzaWxseVxuXG5sZXQgY29uZmlnID0ge1xuICAnZGVmYXVsdCc6ICdpbmZvJ1xufTtcblxubGV0IG1rTG9nQ29uZmlnID0gKGxhYmVsOiBzdHJpbmcsIGxldmVsOiBzdHJpbmcpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBsZXZlbDogbGV2ZWwsXG4gICAgdHJhbnNwb3J0czogW1xuICAgICAgbmV3ICh3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSkoeyBjb2xvcml6ZTogdHJ1ZSwgbGFiZWw6IGxhYmVsLCB0aW1lc3RhbXA6IHRydWUgfSlcbiAgICBdXG4gIH1cbn1cblxuY29uc3QgbG9nZ2VyID0gYWRkTG9nZ2VyKCdMT0dfRkFDVE9SWScpO1xuXG5leHBvcnQgbGV0IGluaXQgPSAobG9nKTogdm9pZCA9PiB7XG5cbiAgbG9nZ2VyLmRlYnVnKCdpbml0OiAnLCBsb2cpO1xuXG4gIGlmICghbG9nKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKF8uaXNPYmplY3QobG9nKSkge1xuICAgIHNldENvbmZpZyhsb2cpO1xuICB9IGVsc2UgaWYgKGlzTG9nTGV2ZWwobG9nKSkge1xuICAgIHNldERlZmF1bHRMZXZlbChsb2cpO1xuICB9IGVsc2Uge1xuICAgIHRyeSB7XG4gICAgICBsZXQgY29uZmlnID0gSlNPTi5wYXJzZShsb2cpO1xuICAgICAgbG9nZ2VyLmRlYnVnKCdwYXJzZWQgbG9nOiAnLCBsb2cpO1xuICAgICAgc2V0Q29uZmlnKGNvbmZpZyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobG9nKSkge1xuICAgICAgICB2YXIgY2ZnID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMobG9nLCAndXRmOCcpKTtcbiAgICAgICAgc2V0Q29uZmlnKGNmZyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdjYW4gbm90IGNvbmZpZ3VyZSBsb2dnaW5nIHVzaW5nIGNsaSBwYXJhbSB2YWx1ZTogJyArIGxvZyk7XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG5sZXQgc2V0Q29uZmlnID0gKGNmZykgPT4ge1xuICBjb25maWcgPSBfLm1lcmdlKHt9LCBjb25maWcsIGNmZyk7XG4gIF8uZm9ySW4oY2ZnLCAodmFsdWUsIGtleSkgPT4ge1xuICAgIGFkZExvZ2dlcihrZXksIHZhbHVlKTtcbiAgfSk7XG59O1xuXG5mdW5jdGlvbiBhZGRMb2dnZXIobGFiZWwsIGxldmVsPzogc3RyaW5nKTogd2luc3Rvbi5Mb2dnZXJJbnN0YW5jZSB7XG4gIGxldmVsID0gbGV2ZWwgPyBsZXZlbCA6IGNvbmZpZ1snZGVmYXVsdCddIHx8ICdpbmZvJztcbiAgbGV0IGNmZyA9IG1rTG9nQ29uZmlnKGxhYmVsLCBsZXZlbCk7XG4gIGxldCBsb2dnZXI7XG4gIGlmICh3aW5zdG9uLmxvZ2dlcnMuaGFzKGxhYmVsKSkge1xuICAgIGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5nZXQobGFiZWwpO1xuICB9IGVsc2Uge1xuICAgIGxvZ2dlciA9IHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHt9KTtcbiAgfVxuXG4gIGxvZ2dlci5jb25maWd1cmUoY2ZnKTtcbiAgcmV0dXJuIGxvZ2dlcjtcbn1cblxuXG5sZXQgaXNMb2dMZXZlbCA9IChsKTogQm9vbGVhbiA9PiBfLmluY2x1ZGVzKFsnZXJyb3InLCAnd2FybicsICdpbmZvJywgJ3ZlcmJvc2UnLCAnZGVidWcnLCAnc2lsbHknXSwgbCk7XG5cblxuZXhwb3J0IGxldCBzZXREZWZhdWx0TGV2ZWwgPSAobCkgPT4ge1xuICBjb25maWcgPSBfLm1lcmdlKGNvbmZpZywgeyAnZGVmYXVsdCc6IGwgfSk7XG4gIGxvZ2dlci5kZWJ1ZygnZGVmYXVsdCBsZXZlbCBub3c6ICcsIGNvbmZpZ1snZGVmYXVsdCddKTtcbiAgXy5mb3JFYWNoKHdpbnN0b24ubG9nZ2Vycy5sb2dnZXJzLCAodmFsdWUsIGtleSkgPT4ge1xuICAgIGxldCBsb2dnZXIgPSB3aW5zdG9uLmxvZ2dlcnMuZ2V0KGtleSk7XG4gICAgbGV0IGNmZyA9IG1rTG9nQ29uZmlnKGtleSwgY29uZmlnWydkZWZhdWx0J10pO1xuICAgIGxvZ2dlci5jb25maWd1cmUoY2ZnKTtcbiAgfSk7XG59O1xuXG5cbi8qKiBnZXQgYSBsb2dnZXIgYW5kIGdpdmUgaXQgYSBuYW1lICovXG5leHBvcnQgbGV0IGdldExvZ2dlciA9IChpZDogc3RyaW5nKTogd2luc3Rvbi5Mb2dnZXJJbnN0YW5jZSA9PiB7XG4gIHZhciBleGlzdGluZyA9IHdpbnN0b24ubG9nZ2Vycy5oYXMoaWQpO1xuXG4gIGlmIChleGlzdGluZykge1xuICAgIHJldHVybiB3aW5zdG9uLmxvZ2dlcnMuZ2V0KGlkKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYWRkTG9nZ2VyKGlkLCBjb25maWdbaWRdIHx8IGNvbmZpZ1snZGVmYXVsdCddKTtcbiAgfVxufTtcblxuLyoqIGdldCBhIGxvZ2dlciBhbmQgbmFtZSBpdCBieSBpdCdzIGZpbGUgbmFtZS4gKi9cbmV4cG9ydCBsZXQgZmlsZUxvZ2dlciA9IChmaWxlbmFtZSk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2UgPT4ge1xuICB2YXIgbGFiZWw7XG4gIHZhciBwYXJzZWQgPSBwYXRoLnBhcnNlKGZpbGVuYW1lKTtcblxuICBpZiAocGFyc2VkLm5hbWUgPT09ICdpbmRleCcpIHtcbiAgICBsYWJlbCA9IHBhdGguYmFzZW5hbWUocGFyc2VkLmRpcik7XG4gIH0gZWxzZSB7XG4gICAgbGFiZWwgPSBwYXJzZWQubmFtZTtcbiAgfVxuICByZXR1cm4gZ2V0TG9nZ2VyKGxhYmVsKTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBsb2dnZXIgYW5kIGF1dG9tYXRpY2FsbHkgbmFtZSBpdCBieSB1c2luZyB0aGUgZmlsZW5hbWUgb2YgdGhlIGNhbGwgc2l0ZS5cbiAqIEVnOlxuICogYGBgXG4gKiAvL215LWZpbGUuanNcbiAqIGltcG9ydCB7YnVpbGRMb2dnZXJ9IGZyb20gJ2xvZy1mYWN0b3J5JztcbiAqIGxldCBsb2dnZXIgPSBidWlsZExvZ2dlcigpO1xuICogbG9nZ2VyLmluZm8oJ2hpJykgLy89PiBlbWl0cyBbSU5GT10gW215LWZpbGVdIGhpXG4gKiBgYGBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkTG9nZ2VyKCk6IHdpbnN0b24uTG9nZ2VySW5zdGFuY2Uge1xuICBsZXQgdHJhY2UgPSBzdGFja1RyYWNlLmdldCgpO1xuICBsZXQgbmFtZSA9IHRyYWNlWzFdLmdldEZpbGVOYW1lKCk7XG4gIHJldHVybiBmaWxlTG9nZ2VyKG5hbWUpO1xufVxuXG5cbiJdfQ==
